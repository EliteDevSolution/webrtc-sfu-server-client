<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="icon" href="./favicon.ico"/>
    <title>Streaming Video</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>
    <nav class="navbar navbar-expand-sm navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="javascript:void(0)">Streaming Video</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mynavbar">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="mynavbar">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="javascript:void(0)">Viewer</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="javascript:void(0)">Server</a>
                    </li>
                </ul>
                <div class="d-flex">
                    <input id="resource" class="form-control me-2" type="text" placeholder="Channel ID..." />
                    <input id="token" class="form-control me-2" type="text" placeholder="Bearer Token..." />
                    <button class="btn btn-primary" type="button">Reset</button>
                </div>
            </div>
        </div>
    </nav>
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-8 p-3">
                <section style="display: none;">
                    <select onchange="selectWidthValue(this.value)">
                        <option value="320px">320px</option>
                        <option value="480px">480px</option>
                        <option value="600px">600px</option>
                        <option value="1280px">1280px</option>
                        <option value="1920px">1920px</option>
                        <option value="auto">auto</option>
                    </select>
                </section>
                <section>
                    <debug-player controls autoplay id="whep-video-player" class="video-js"></debug-player>
                    <video autoplay="" controls="" id="video" style="width: 100%; height: auto"></video>
                </section>
            </div>
            <div class="col-sm-4 p-3">
                <section style="display: none;">
                    SVC Layer:
                    <div class="select">
                        <select disabled id="whep-layer-select">
                           <option selected disabled>Choose a book format</option>
                           <option value="pdf">PDF</option>
                           <option value="txt">txt</option>
                           <option value="epub">ePub</option>
                           <option value="fb2">fb2</option>
                           <option value="mobi">mobi</option>
                        </select>
                     </div>
                </section>
                <section style="margin-top: 20px;">
                    <button onclick="startWhep()" class="btn btn-outline-success">Start</button>
                    <button id="whep-button-stop" class="btn btn-outline-warning">Stop</button>
                    <button id="whep-button-disable-audio" class="btn btn-outline-danger">Disable Audio</button>
                    <button id="whep-button-disable-video" class="btn btn-outline-danger">Disable Video</button>
                </section>
                <section style="display: none;">
                    <data-channel id="whep-datachannel"></data-channel>
                </section>
                <div id="whep-logs" style="height: 450px; overflow: auto; border: 2px solid #d9d9d9; padding: 10px; margin-top: 20px;"></div>
            </div>
        </div>
    </div>
<script>
    function selectWidthValue(value){
        const video = document.getElementById("video");
        video.style.width = value;
    }
</script>
<script type="module">
    import convertSessionDescription from "./sdp.js"
    import {WHEPClient} from "./whep.js"

    import VideoSizeSelectElement from "./components/video-size-select.js"
    import DebugPlayer from "./components/debug-player.js"
    import DataChannel from "./components/data-channel.js"

    customElements.define("video-size-select", VideoSizeSelectElement)
    customElements.define("debug-player", DebugPlayer)
    customElements.define("data-channel", DataChannel)

    // Common
    const idResourceId = "resource"
    const idBearerToken = "token"

    function setURLSearchParams(k, v) {
        const params = new URLSearchParams((new URL(location.href)).search)
        !!v ? params.set(k, v) : params.delete(k)
        history.replaceState({}, "", "?" + params.toString())
    }

    function getURLSearchParams(k) {
        const params = new URLSearchParams((new URL(location.href)).search)
        return params.get(k)
    }

    function initCommonInput(elementId, paramId) {
        const element = document.getElementById(elementId)
        if (element) {
            element.addEventListener('input', ev => setURLSearchParams(paramId, ev.target.value))
            element.value = getURLSearchParams(paramId)
        }
    }

    initCommonInput(idResourceId, idResourceId)
    initCommonInput(idBearerToken, idBearerToken)

    function log(el, num, msg) {
        el.innerHTML += (!!num ? `[${num}]: ` : '') + msg + '<br>'
    }

    function logWhep(num, msg) {
        log(document.getElementById('whep-logs'), num, msg)
    }

    function getElementValue(elementId) {
        const el = document.getElementById(elementId)
        return el ? el.value : ""
    }

    const layers = [
        {rid: 'q', scaleResolutionDownBy: 4.0, scalabilityMode: 'L1T3'},
        {rid: 'h', scaleResolutionDownBy: 2.0, scalabilityMode: 'L1T3'},
        {rid: 'f', scalabilityMode: 'L1T3'}
    ]

    function initLayerSelect(elementId, opts) {
        const selectLayer = document.getElementById(elementId)
        if (selectLayer) opts.map(i => {
            const opt = document.createElement("option")
            opt.value = i.value
            opt.text = i.text
            selectLayer.appendChild(opt)
        })
    }

    // WHEP
    let whepNum = 0

    const idWhepLayerSelect = "whep-layer-select"
    const idWhepButtonStop = "whep-button-stop"
    const idWhepButtonDisableAudio = "whep-button-disable-audio"
    const idWhepButtonDisableVideo = "whep-button-disable-video"
    const idWhepDataChannel = "whep-datachannel"

    initLayerSelect(idWhepLayerSelect, [
        {value: "", text: "AUTO"},
        {value: "q", text: "LOW"},
        {value: "h", text: "MEDIUM"},
        {value: "f", text: "HIGH"},
    ])

    async function startWhep() {
        const resource = getElementValue(idResourceId)
        if (!resource) {
            alert("input resource")
            return
        }
        const num = whepNum++
        logWhep(num, "started")
        const pc = new RTCPeerConnection()

        // NOTE:
        // 1. Live777 Don't support label
        // 2. Live777 Don't support negotiated
        document.getElementById(idWhepDataChannel).dataChannel = pc.createDataChannel("")

        pc.oniceconnectionstatechange = e => logWhep(num, pc.iceConnectionState)
        pc.addTransceiver('video', {'direction': 'recvonly'})
        pc.addTransceiver('audio', {'direction': 'recvonly'})
        pc.ontrack = ev => {
            logWhep(num, `track: ${ev.track.kind}`)
            if (ev.track.kind === "video") {
                if (ev.streams.length !== 0) document.getElementById("whep-video-player").srcObject = ev.streams[0]
            }
        }
        const whep = new WHEPClient()
        const url = location.origin + "/whep/" + resource
        const token = getElementValue(idBearerToken)

        try {
            logWhep(num, "http begined")
            await whep.view(pc, url, token)
        } catch (e) {
            logWhep(num, e)
        }

        const element = document.getElementById(idWhepButtonStop)
        if (element) element.addEventListener('click', async () => {
            await whep.stop()
            logWhep(num, "stopped")
        })

        const buttonDisableAudio = document.getElementById(idWhepButtonDisableAudio)
        let flagButtonDisableAudio = false
        buttonDisableAudio.onclick = async () => {
            await whep.mute({ kind: "audio", enabled: flagButtonDisableAudio })
            buttonDisableAudio.innerText = flagButtonDisableAudio ? "Disable Audio" : "Enable Audio"
            flagButtonDisableAudio = !flagButtonDisableAudio
        }

        const buttonDisableVideo = document.getElementById(idWhepButtonDisableVideo)
        let flagButtonDisableVideo = false
        buttonDisableVideo.onclick = async () => {
            await whep.mute({ kind: "video", enabled: flagButtonDisableVideo })
            buttonDisableVideo.innerText = flagButtonDisableVideo ? "Disable Video" : "Enable Video"
            flagButtonDisableVideo = !flagButtonDisableVideo
        }

        const initEvevt = () => {
            const el = document.getElementById(idWhepLayerSelect)
            if (el) el.onchange = ev => !ev.target.value ? whep.unselectLayer() : whep.selectLayer({"encodingId": ev.target.value}).catch(e => logWhep(e))
        }

        if (whep.layerUrl) {
            const selectLayer = document.getElementById(idWhepLayerSelect)
            if (selectLayer) selectLayer.disabled = false
            initEvevt()
        }
    }

    window.startWhep = startWhep
</script>
</body>

</html>
